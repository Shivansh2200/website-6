<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Use case 3 - Tungsten Fabric Carbide Evaluation Guide</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/text.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="..">Tungsten Fabric Carbide Evaluation Guide</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="..">Home</a>
                            </li>
                            <li >
                                <a href="../use_case_1/">Use case 1</a>
                            </li>
                            <li >
                                <a href="../use_case_2/">Use case 2</a>
                            </li>
                            <li class="active">
                                <a href="./">Use case 3</a>
                            </li>
                            <li >
                                <a href="../use_case_4/">Use case 4</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../use_case_2/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../use_case_4/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#use-case-3-coarse-application-isolation-through-kubernetes-namespaces">Use case 3: Coarse application isolation through Kubernetes Namespaces</a></li>
            <li><a href="#when-would-i-care">When would I care?</a></li>
            <li><a href="#adding-an-isolated-namespace">Adding an isolated Namespace</a></li>
            <li><a href="#deploy-sample-app-into-an-isolated-namespace">Deploy sample app into an isolated Namespace</a></li>
            <li><a href="#cleanup">Cleanup</a></li>
            <li><a href="#recap-and-whats-next">Recap and what's next</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h2 id="use-case-3-coarse-application-isolation-through-kubernetes-namespaces">Use case 3: Coarse application isolation through Kubernetes Namespaces</h2>
<p><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">Kubernetes Namespaces</a> is a built-in means to "virtualise" Kubernetes clusters. While the jury <a href="https://youtu.be/_VNv7jBh1XA?t=573">is currently out</a> regarding how and where to use Namespaces, cluster virtualisation can not be complete without the ability to isolate namespaces network-wise.</p>
<p>Tungsten Fabric Kubernetes CNI plugin includes support for <code>isolated</code> Namespaces. An application deployed into an isolated Namespace cannot reach any Pods outside the Namespace it's in, and its Pods and Services cannot be reached by applications from other Namespaces.</p>
<h3 id="when-would-i-care">When would I care?</h3>
<p>One approach that organisations use is to deploy separate Kubernetes clusters per development team, in which case there's little benefit to having cluster virtualisation and namespace separation.</p>
<p>However this approach may lead to inefficient use of resources, because unused capacity is fragmented. Each cluster has its own free capacity that cannot be used by applications running in other clusters. Additionally, as the number of clusters grows, it introduces operational overhead to keep things uniform. And last but not least, it takes time to bring up a new cluster, which may slow things down.</p>
<p>Namespaces are a good way to work around these problems as they help to reduce the number of clusters, share the spare capacity, and are quick to create. They can also provide a level of separation where an infrastructure team would look after the clusters, while individual developer teams operate within their own namespaces.</p>
<p>There are three general areas that need to be addressed when dealing with cluster virtualisation: (1) who can access the virtual cluster (RBAC); (2) how much compute resources each virtual cluster can use; and (3) what network communications are allowed for applications in virtual clusters.</p>
<p>Tungsten Fabric CNI plugin for Kubernetes is designed to help with the (3) through Namespace isolation that this section will talk about, and NetworkPolicy that is covered by the next section.  This is especially useful from a regulatory compliance standpoint.  PCI compliance is a great example, as it encourages workload isolation.</p>
<p>When looking to achieve PCI compliance, one of the key areas of focus is scope reduction.  The goal of scope reduction is to isolate all systems which can affect the systems which process credit card information, known as the Cardholder Data Environment (CDE) in any way.  </p>
<p>Any workload or device that can interact in any way with a system that is part of the CDE is considered in scope.  Network segmentation is critical to achieving the isolation required to reduce the number of systems that would be considered in scope for PCI compliance purposes.</p>
<p>Kubernetes namespaces, and the underlying containerization platforms Kubernetes orchestrates, provide the compute isolation needed to reduce PCI scope for containerized workloads.  Kubernetes also provides part of the solution regarding storage isolation, however, Kubernetes currently does not offer adequate network isolation or inspection for this purpose.</p>
<p>Tungsten Fabric CNI plugin for Kubernetes not only provides Kubernetes namespace-aware network isolation capabilities, it also provides operations teams the ability to inspect all network traffic in and out of a namespace by steering that traffic through Network Functions Virtualization (NFV) instances.  This allows for the level of data flow inspection to be adjusted as required by the types of communication that must be allowed in and out of the isolated CDE.</p>
<p>Let's explore an example of network isolation using Kubernetes namespaces.  In this use case, we will deploy two copies of our sample app, one into the default Namespace, and one into a new isolated Namespace. We will then see how Tungsten Fabric enforces network communication isolation, as shown on this diagram:</p>
<p><img alt="alt_text" src="../images/image12.png" title="image_tooltip" /></p>
<h3 id="adding-an-isolated-namespace">Adding an isolated Namespace</h3>
<p>Before jumping in, it's worth to quickly scan <a href="https://kubernetes.io/docs/tasks/administer-cluster/namespaces/">Kubernetes documentation page</a> that explains how to work with Namespaces, including commands we will need to know.</p>
<p>All done? Make sure you're on the sandbox control node, logged in as root, and in the correct directory:</p>
<pre><code class="bash"># Make sure we're root
whoami | grep root || sudo -s

# Change to the manifests directory
cd /home/centos/yelb/deployments/platformdeployment/Kubernetes/yaml
</code></pre>

<p>Next, let's create a new manifest that describes our new isolated Namespace:</p>
<pre><code class="bash">cat &gt; dev-isolated.yaml &lt;&lt;EOF
apiVersion: v1
kind: Namespace
metadata:
 name: &quot;dev-isolated&quot;
 annotations: {
   &quot;opencontrail.org/isolation&quot; : &quot;true&quot;
 }
EOF
</code></pre>

<p>This should create a file called <code>dev-isolated.yaml</code> with the contents above. Note the <code>annotations</code> section - this is what will tell Tungsten Fabric to make your new Namespace isolated.</p>
<p>Go ahead to create this namespace and add a new context to Kubernetes config file so that we can access it:</p>
<pre><code class="bash"># Create our new Namespace:
kubectl create -f dev-isolated.yaml
</code></pre>

<p>Let's have a quick look at our new Namespace:</p>
<pre><code class="text"># kubectl describe ns dev-isolated
Name:         dev-isolated
Labels:       &lt;none&gt;
Annotations:  opencontrail.org/isolation=true
Status:       Active
No resource quota.
No resource limits.
</code></pre>

<p>Note the <code>Annotations</code> field; this signalled to Tungsten Fabric CNI plugin that it needs to treat this Namespace differently.</p>
<blockquote>
<p>Could we have simply added this annotation to an existing Namespace to make it isolated? Unfortunately no, because Tungsten has to do a fair bit of additional work to set up a new Namespace as isolated. More specifically, if has to create a set of separate Virtual Networks that applications Pods in this Namespace will be connected to.</p>
<p>This ensures the network separation is maintained at a fundamental level, rather than simply through weaker methods like traffic filters.</p>
</blockquote>
<h3 id="deploy-sample-app-into-an-isolated-namespace">Deploy sample app into an isolated Namespace</h3>
<p>Next we will deploy our sample application into the isolated Namespace that we've created:</p>
<pre><code class="bash">kubectl create --namespace dev-isolated -f cnawebapp-loadbalancer.yaml
</code></pre>

<p>Once the application pods are up, we should be able to access our application from the Internet same as described in Use case 1 above.</p>
<p>Next we'll need something to compare and contrast with; so let's deploy another copy of our sample app, but this time into the <code>default</code> Namespace:</p>
<pre><code class="bash">kubectl create -f cnawebapp-loadbalancer.yaml
</code></pre>

<p>Now we have two copies of our app; one is running in the <code>default</code> Namespace that is not isolated, the other is in <code>dev-isolated</code> Namespace that is.</p>
<p>The behaviour that we expect:</p>
<ol>
<li>Pods and Services in non-isolated Namespace should be reachable from other Pods in non-isolated Namespaces (such as <code>default</code> and <code>kube-system</code>)</li>
<li>Services in non-isolated Namespaces should be reachable from Pods running in isolated Namespaces</li>
<li>Pods and Services in isolated Namespaces should only be reachable from Pods in the same Namespace</li>
<li>Exception to the above: Services of type <code>LoadBalancer</code> in isolated Namespaces will be reachable from the outside world.</li>
</ol>
<p>Let's validate this point by point.</p>
<h4 id="pods-in-non-isolated-namespaces-should-be-able-to-talk">Pods in non-isolated Namespaces should be able to talk</h4>
<p>We know that Pods can talk to Services in our <code>default</code> namespace - that's how our sample app works. But what about across namespaces? Since we're in a sandbox, we could use one of Pods in <code>kube-system</code> namespace to try reach Pods and Services in our app that's running in the non-isolated namespace <code>default</code>:</p>
<pre><code class="bash"># Get the name of one of the kube-system pods; tiller-deploy:
src_pod=$(kubectl get pods --namespace kube-system | grep tiller | awk '{print $1}')

# Now let's get an IP of the &quot;yelb-ui&quot; pod in &quot;default&quot; namespace:
dst_pod_ip=$(kubectl get pods -o wide | grep yelb-ui | awk '{print $6}')

# Now let's ask tiller-deploy to ping yelb-ui:
kubectl exec --namespace kube-system -it ${src_pod} ping ${dst_pod_ip}
</code></pre>

<p>The last command should result in output similar to:</p>
<pre><code class="text">PING 10.47.255.246 (10.47.255.246): 56 data bytes
64 bytes from 10.47.255.246: seq=0 ttl=63 time=1.291 ms
64 bytes from 10.47.255.246: seq=1 ttl=63 time=0.576 ms
</code></pre>

<p>Cancel the command with ^C. This confirms that pods in non-isolated namespaces can reach each other.</p>
<h4 id="isolated-pods-should-be-able-to-reach-non-isolated-services">Isolated Pods should be able to reach non-isolated Services</h4>
<pre><code class="bash"># Get the Cluster IP of the `yelb-ui` Service running in the `default` Namespace:
default_yelb_ui_ip=$(kubectl get svc --namespace default -o wide | grep yelb-ui | awk '{print $3'})

# Get the name of &quot;yelb-appserver&quot; Pod in the &quot;dev-isolated&quot; Namespace:
src_pod2=$(kubectl get pods --namespace dev-isolated | grep yelb-appserver | awk '{print $1}')

# Run &quot;curl&quot; on &quot;yelb-appserver&quot; trying to reach the Service IP in &quot;default&quot; Namespace:
kubectl exec -it -n dev-isolated ${src_pod2} -- /usr/bin/curl http://${default_yelb_ui_ip}
</code></pre>

<p>We should see ~10 lines of HTML code of our main <code>yelb-ui</code> page, which shows that a Pod in <code>dev-isolated</code> Namespace can talk to a Service in non-isolated <code>default</code> Namespace.</p>
<h4 id="pods-in-an-isolated-namespace-should-not-be-reachable-from-other-namespaces">Pods in an isolated Namespace should not be reachable from other Namespaces</h4>
<p>Now, let's try to ping <code>yelb-ui</code> Pod that's running in the <code>dev-isolated</code> Namespace from the same <code>tiller-deploy</code> Pod:</p>
<pre><code class="bash"># Get an IP of the &quot;yelb-ui&quot; pod in &quot;dev-isolated&quot; namespace:
isolated_pod_ip=$(kubectl get pods --namespace dev-isolated -o wide | grep yelb-ui | awk '{print $6}')

# ..and try pinging it:
kubectl exec --namespace kube-system -it ${src_pod} ping ${isolated_pod_ip}
</code></pre>

<p>You should see that the command is "stuck", not displaying any responses because this time we're trying to reach something that isn't reachable because Tungsten Fabric is preventing it.</p>
<p>Press ^C to cancel the command.</p>
<p>Experiment a bit more on your own - try pinging isolated <code>yelb</code> Pods and Services from <code>yelb</code> Pods in <code>default</code> Namespace. Is everything working as you expected it to?</p>
<h4 id="loadbalancer-services-in-isolated-namespaces-should-be-accessible-outside">LoadBalancer Services in isolated Namespaces should be accessible outside</h4>
<p>It wouldn't be much point to run application in an isolated Namespace if we couldn't access it, though. Therefore, our copy of <code>yelb</code> that is running in an isolated Namespace <code>dev-isolated</code> should be available to the Internet through the <code>LoadBalancer</code> Service <code>yelb-ui</code>. Let's test it:</p>
<pre><code class="bash">kubectl get svc --namespace dev-isolated -o wide | grep yelb-ui | awk '{print $4}'
</code></pre>

<p>It should display something like <code>afd9047c2915911e9b411026463a4a33-777914712.us-west-1.elb.amazonaws.com</code>; point your browser to it and see if our application loads!</p>
<h3 id="cleanup">Cleanup</h3>
<p>Once you've explored enough, feel free to clean things up:</p>
<pre><code class="bash"># Delete the two copies of &quot;yelb&quot;:
kubectl delete -f cnawebapp-loadbalancer.yaml
kubectl delete --namespace dev-isolated -f cnawebapp-loadbalancer.yaml

# Delete the isolated namespace and its Manifest:
kubectl delete -f dev-isolated.yaml
rm -f dev-isolated.yaml
</code></pre>

<h3 id="recap-and-whats-next">Recap and what's next</h3>
<p>Kubernetes Namespaces have been designed as a means of virtualising Kubernetes clusters. No virtualisation is complete without networking, and Tungsten Fabric's support for isolated Namespaces provides this function.</p>
<p>Isolated Namespaces however have low granularity that you may need when implementing application network security policies within your Namespace.</p>
<p>To get familiar with these more fine controls, check out the Use Case 4.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
